name: CI

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build-and-test:
    runs-on: windows-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0.x

      - name: Restore and test managed/tooling
        run: dotnet test dff.sln --nologo

      - name: Configure native build
        run: cmake -S engine/native -B engine/native/build

      - name: Build native
        run: cmake --build engine/native/build --config Debug

      - name: Run native tests
        run: ctest --test-dir engine/native/build -C Debug --output-on-failure

      - name: Build native (Release)
        run: cmake --build engine/native/build --config Release

      - name: Run native tests (Release)
        run: ctest --test-dir engine/native/build -C Release --output-on-failure

      - name: Generate release test artifacts
        run: >-
          dotnet run --project engine/tools/engine-cli/Engine.Cli.csproj -c Release --
          test --project . --configuration Release --out artifacts/tests

      - name: Run process-level multiplayer orchestration
        run: >-
          dotnet run --project engine/tools/engine-cli/Engine.Cli.csproj -c Release --
          multiplayer orchestrate --project . --configuration Release
          --out artifacts/runtime-multiplayer-orchestration
          --require-native-transport false
          --cli-project engine/tools/engine-cli/Engine.Cli.csproj

      - name: Generate NFR release proof
        run: >-
          dotnet run --project engine/tools/engine-cli/Engine.Cli.csproj -c Release --
          nfr proof --project . --configuration Release --out artifacts/nfr/release-proof.json

      - name: Prepare root project markers for doctor
        shell: pwsh
        run: |
          if (-not (Test-Path "project.json")) {
            @"
{
  "name": "ci-root",
  "assetRoot": "assets",
  "scripts": {}
}
"@ | Set-Content -Path "project.json" -Encoding UTF8
          }

          if (-not (Test-Path "assets")) {
            New-Item -ItemType Directory -Path "assets" | Out-Null
          }

          if (-not (Test-Path "assets/manifest.json")) {
            @"
{
  "version": 1,
  "assets": []
}
"@ | Set-Content -Path "assets/manifest.json" -Encoding UTF8
          }

          if (-not (Test-Path "src")) {
            New-Item -ItemType Directory -Path "src" | Out-Null
          }

      - name: Validate release artifacts with doctor
        run: >-
          dotnet run --project engine/tools/engine-cli/Engine.Cli.csproj -c Release --
          doctor --project .
          --runtime-perf artifacts/tests/runtime/perf-metrics.json
          --verify-multiplayer-snapshot true
          --multiplayer-snapshot artifacts/tests/net/multiplayer-snapshot.bin
          --verify-multiplayer-rpc true
          --multiplayer-rpc artifacts/tests/net/multiplayer-rpc.bin
          --verify-multiplayer-orchestration true
          --multiplayer-orchestration artifacts/runtime-multiplayer-orchestration/net/multiplayer-orchestration.json
          --verify-capture-rgba16f true
          --capture-rgba16f artifacts/tests/screenshots/frame-0001.rgba16f.bin
          --verify-render-stats true
          --render-stats artifacts/tests/render/frame-stats.json
          --verify-test-host-config true
          --test-host-config artifacts/tests/runtime/test-host.json
          --verify-net-profile-log true
          --net-profile-log artifacts/tests/net/multiplayer-profile.log
          --verify-replay-recording true
          --replay-recording artifacts/tests/replay/recording.json
          --verify-artifacts-manifest true
          --artifacts-manifest artifacts/tests/manifest.json
          --verify-release-proof true
          --release-proof artifacts/nfr/release-proof.json

  pack-clean-machine:
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            runtime: win-x64
          - os: ubuntu-latest
            runtime: linux-x64

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: 9.0.x

      - name: Initialize pack smoke project
        shell: pwsh
        run: >-
          dotnet run --project engine/tools/engine-cli/Engine.Cli.csproj -c Release --
          init --name CiPackSmoke --output artifacts/clean-machine/project

      - name: Run clean-machine pack smoke
        shell: pwsh
        run: >-
          dotnet run --project engine/tools/engine-cli/Engine.Cli.csproj -c Release --
          pack --project artifacts/clean-machine/project/CiPackSmoke
          --manifest assets/manifest.json
          --output dist/content.pak
          --runtime ${{ matrix.runtime }}
          --configuration Release
          --zip dist/package.zip

      - name: Verify packaged portable layout
        shell: pwsh
        run: |
          $root = "artifacts/clean-machine/project/CiPackSmoke/dist"
          $required = @(
            "$root/content.pak",
            "$root/compiled.manifest.bin",
            "$root/package.zip",
            "$root/package/App",
            "$root/package/Content/Game.pak",
            "$root/package/Content/compiled.manifest.bin",
            "$root/package/config/runtime.json"
          )

          foreach ($path in $required) {
            if (-not (Test-Path $path)) {
              throw "Required packaged artifact is missing: $path"
            }
          }

      - name: Upload clean-machine package artifacts
        uses: actions/upload-artifact@v4
        with:
          name: clean-machine-pack-${{ matrix.runtime }}
          path: artifacts/clean-machine/project/CiPackSmoke/dist
